name: Project and Status Sync

on:
  issues:
    types: [opened, edited, reopened, labeled, unlabeled, closed, reopened]
  workflow_dispatch: # Manual trigger for bulk sync
    inputs:
      sync_all:
        description: "Sync all open issues to project"
        required: false
        default: "false"

jobs:
  sync-to-project:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Add issue to Project 4 using GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GH_USER_PROJECT_TOKEN }}
        run: |
          issue_number="${{ github.event.issue.number }}"
          echo "ðŸ” Processing issue #$issue_number"
          
          # Try to add issue to project using gh CLI
          if gh project item-add 4 \
            --owner "@me" \
            --url "https://github.com/${{ github.repository }}/issues/$issue_number" 2>&1; then
            echo "âœ… Added issue #$issue_number to Project 4"
          else
            echo "â„¹ï¸  Issue #$issue_number already in Project 4 (or other error)"
          fi

  sync-status-labels:
    runs-on: ubuntu-latest
    needs: sync-to-project
    permissions:
      issues: write
      contents: read

    steps:
      - name: Validate and sync status labels
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;

            if (!issue) {
              console.log('â„¹ï¸  No issue in payload');
              return;
            }

            const labels = issue.labels.map(l => l.name);
            const body = issue.body || '';
            const state = issue.state;

            console.log(`ðŸ” Validating status for issue #${issue.number}`);
            console.log(`Current labels: ${labels.join(', ')}`);
            console.log(`Issue state: ${state}`);

            // ============================================
            // RULE 1: Extract status from issue body
            // ============================================
            const statusPattern = /(?:^|\n)(?:\*\*)?Status(?:\*\*)?:\s*(.+?)(?:\n|$)/i;
            const statusMatch = body.match(statusPattern);
            const bodyStatus = statusMatch ? statusMatch[1].trim() : null;

            console.log(`Body status: ${bodyStatus || '(not found)'}`);

            // ============================================
            // RULE 2: Determine correct status label based on body and state
            // ============================================
            let correctStatusLabel = null;

            // Closed issues should always have status:closed
            if (state === 'closed') {
              correctStatusLabel = 'status:closed';
            } 
            // Parse body status
            else if (bodyStatus) {
              const statusLower = bodyStatus.toLowerCase();
              
              // ADR statuses
              if (statusLower.includes('accepted')) {
                correctStatusLabel = 'status:completed';
              } else if (statusLower.includes('proposed') || statusLower.includes('under review')) {
                correctStatusLabel = 'status:in-progress';
              } else if (statusLower.includes('rejected') || statusLower.includes('deprecated')) {
                correctStatusLabel = 'status:completed';
              }
              // Component/Implementation statuses
              else if (statusLower.includes('implemented') || statusLower.includes('production')) {
                correctStatusLabel = 'status:completed';
              } else if (statusLower.includes('partially implemented')) {
                correctStatusLabel = 'status:in-progress';
              } else if (statusLower.includes('planned')) {
                correctStatusLabel = 'status:backlog';
              }
              // Requirement statuses
              else if (statusLower.includes('complete') || statusLower.includes('âœ…')) {
                correctStatusLabel = 'status:completed';
              } else if (statusLower.includes('verified') || statusLower.includes('validated')) {
                correctStatusLabel = 'status:completed';
              } else if (statusLower.includes('draft') || statusLower.includes('analyzed')) {
                correctStatusLabel = 'status:in-progress';
              } else if (statusLower.includes('baselined') || statusLower.includes('approved')) {
                correctStatusLabel = 'status:completed';
              }
              // Generic workflow statuses
              else if (statusLower.includes('in progress') || statusLower.includes('in-progress')) {
                correctStatusLabel = 'status:in-progress';
              } else if (statusLower.includes('review')) {
                correctStatusLabel = 'status:review';
              } else if (statusLower.includes('testing')) {
                correctStatusLabel = 'status:testing';
              } else if (statusLower.includes('blocked')) {
                correctStatusLabel = 'status:blocked';
              } else if (statusLower.includes('backlog') || statusLower.includes('open')) {
                correctStatusLabel = 'status:backlog';
              }
            }

            // Default to backlog for open issues without clear status
            if (!correctStatusLabel && state === 'open') {
              correctStatusLabel = 'status:backlog';
            }

            console.log(`Correct status label: ${correctStatusLabel}`);

            // ============================================
            // RULE 3: Check current status labels
            // ============================================
            const currentStatusLabels = labels.filter(l => l.startsWith('status:'));

            console.log(`Current status labels: ${currentStatusLabels.join(', ') || '(none)'}`);

            // ============================================
            // RULE 4: Sync if mismatch detected
            // ============================================
            const hasCorrectStatus = currentStatusLabels.includes(correctStatusLabel);
            const hasIncorrectStatus = currentStatusLabels.length === 0 || 
                                       currentStatusLabels.some(l => l !== correctStatusLabel);

            if (!hasCorrectStatus || hasIncorrectStatus) {
              console.log(`ðŸ”§ Status mismatch detected - syncing...`);
              
              // Remove all existing status labels
              for (const label of currentStatusLabels) {
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    name: label
                  });
                  console.log(`  Removed: ${label}`);
                } catch (error) {
                  console.log(`  Could not remove ${label}: ${error.message}`);
                }
              }
              
              // Add correct status label
              if (correctStatusLabel) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: [correctStatusLabel]
                });
                console.log(`  Added: ${correctStatusLabel}`);
                
                // Post comment about status change
                const changeMessage = `## ðŸ¤– Status Sync
                
                **Automatic status update** based on issue body:
                - **Body status**: ${bodyStatus || 'Not specified'}
                - **Previous label(s)**: ${currentStatusLabels.join(', ') || '(none)'}
                - **New label**: \`${correctStatusLabel}\`
                
                This sync ensures consistency between issue status and labels for tracking purposes.
                
                ---
                *Automated by [project-sync.yml](.github/workflows/project-sync.yml)*
                `;
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: changeMessage
                });
                
                console.log(`âœ… Status synced: ${correctStatusLabel}`);
              }
            } else {
              console.log(`âœ… Status label already correct`);
            }

            // ============================================
            // RULE 5: Warn about missing status in body
            // ============================================
            if (!bodyStatus && state === 'open') {
              const warningMessage = `## âš ï¸ Missing Status Field
              
              This issue does not have a clear status field in its body.
              
              **Recommendation**: Add a status field to track progress:
              
              \`\`\`markdown
              **Status**: Draft | In Progress | Under Review | Completed | etc.
              \`\`\`
              
              **Current label**: \`${correctStatusLabel || 'status:backlog'}\` (auto-assigned)
              
              See [Status Management Guide](docs/github-issue-status-management.md) for lifecycle-specific states.
              `;
              
              // Only warn once (check if warning already posted)
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number
              });
              
              const alreadyWarned = comments.data.some(c => 
                c.body.includes('Missing Status Field') && 
                c.user.type === 'Bot'
              );
              
              if (!alreadyWarned) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: warningMessage
                });
                console.log(`âš ï¸  Posted warning about missing status`);
              }
            }

  bulk-sync-all:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.sync_all == 'true'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Setup GitHub CLI
        run: |
          type -p gh >/dev/null || (echo "GitHub CLI not found" && exit 1)
          gh --version

      - name: Verify auth scopes and project visibility
        env:
          GH_TOKEN: ${{ secrets.GH_USER_PROJECT_TOKEN }}
        run: |
          echo "ðŸ” gh auth status (token scopes)"
          gh auth status -t || true
          echo "\nðŸ“‹ Listing user projects for owner: @me"
          gh project list --owner "@me" --limit 20 || true
          echo "\nðŸ”Ž Viewing Project 4 details"
          gh project view 4 --owner "@me" --format json || true

      - name: Fail fast if token cannot access Project 4
        env:
          GH_TOKEN: ${{ secrets.GH_USER_PROJECT_TOKEN }}
        run: |
          echo "ðŸ”Ž Verifying access to user Project 4"
          if ! gh project view 4 --owner "@me" --format json >/dev/null 2>&1; then
            echo "::error::GH_USER_PROJECT_TOKEN lacks required permissions to access user ProjectsV2."
            echo "Required scopes: project, repo, read:org, read:discussion"
            echo "Please regenerate the PAT and update repository secret GH_USER_PROJECT_TOKEN."
            exit 1
          fi

      - name: Sync all open issues to project using gh CLI
        env:
          GH_TOKEN: ${{ secrets.GH_USER_PROJECT_TOKEN }}
        run: |
          echo "ðŸ”„ Starting bulk sync of all open issues to Project 4"
          echo "Repository: ${{ github.repository }}"
          
          # Get all open issue numbers
          issue_numbers=$(gh issue list \
            --repo ${{ github.repository }} \
            --state open \
            --limit 1000 \
            --json number \
            --jq '.[].number')
          
          total_issues=$(echo "$issue_numbers" | wc -l)
          echo "Found $total_issues open issues"
          
          processed=0
          added=0
          skipped=0
          errors=0
          
          for issue_num in $issue_numbers; do
            processed=$((processed + 1))
            echo ""
            echo "[$processed/$total_issues] Processing issue #$issue_num..."
            
            # Try to add issue to project
            if gh project item-add 4 \
              --owner "@me" \
              --url "https://github.com/${{ github.repository }}/issues/$issue_num" 2>&1; then
              echo "  âœ… Added issue #$issue_num"
              added=$((added + 1))
            else
              echo "  â­ï¸  Skipped issue #$issue_num (likely already in project)"
              skipped=$((skipped + 1))
            fi
            
            # Rate limiting delay
            sleep 0.2
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š Bulk Sync Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Total processed: $processed"
          echo "Added to project: $added"
          echo "Already in project: $skipped"
          echo "Errors: $errors"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
      - name: Sync status labels for all issues
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ðŸ”„ Starting status label sync for all issues...');
            
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Get all open issues
            const issuesIterator = github.paginate.iterator(
              github.rest.issues.listForRepo,
              {
                owner: owner,
                repo: repo,
                state: 'open',
                per_page: 100
              }
            );
            
            let syncedCount = 0;
            let unchangedCount = 0;
            
            for await (const { data: issues } of issuesIterator) {
              for (const issue of issues) {
                const labels = issue.labels.map(l => l.name);
                const body = issue.body || '';
                const state = issue.state;
                
                // Extract status from body
                const statusPattern = /(?:^|\n)(?:\*\*)?Status(?:\*\*)?:\s*(.+?)(?:\n|$)/i;
                const statusMatch = body.match(statusPattern);
                const bodyStatus = statusMatch ? statusMatch[1].trim() : null;
                
                if (!bodyStatus) {
                  unchangedCount++;
                  continue;
                }
                
                // Determine correct status label
                let correctStatusLabel = null;
                const statusLower = bodyStatus.toLowerCase();
                
                if (statusLower.includes('accepted') || statusLower.includes('baselined') || 
                    statusLower.includes('approved') || statusLower.includes('complete') ||
                    statusLower.includes('implemented') || statusLower.includes('production') ||
                    statusLower.includes('verified') || statusLower.includes('validated') ||
                    statusLower.includes('âœ…')) {
                  correctStatusLabel = 'status:completed';
                } else if (statusLower.includes('proposed') || statusLower.includes('under review') ||
                           statusLower.includes('partially implemented') || statusLower.includes('draft') ||
                           statusLower.includes('analyzed') || statusLower.includes('in progress') ||
                           statusLower.includes('in-progress')) {
                  correctStatusLabel = 'status:in-progress';
                } else if (statusLower.includes('planned') || statusLower.includes('backlog') ||
                           statusLower.includes('open')) {
                  correctStatusLabel = 'status:backlog';
                }
                
                if (!correctStatusLabel) {
                  unchangedCount++;
                  continue;
                }
                
                // Check if sync needed
                const currentStatusLabels = labels.filter(l => l.startsWith('status:'));
                const hasCorrectStatus = currentStatusLabels.includes(correctStatusLabel);
                
                if (hasCorrectStatus && currentStatusLabels.length === 1) {
                  unchangedCount++;
                  continue;
                }
                
                // Sync status
                console.log(`Syncing issue #${issue.number}: ${bodyStatus} â†’ ${correctStatusLabel}`);
                
                // Remove old status labels
                for (const label of currentStatusLabels) {
                  try {
                    await github.rest.issues.removeLabel({
                      owner: owner,
                      repo: repo,
                      issue_number: issue.number,
                      name: label
                    });
                  } catch (error) {
                    // Ignore if label doesn't exist
                  }
                }
                
                // Add correct status label
                await github.rest.issues.addLabels({
                  owner: owner,
                  repo: repo,
                  issue_number: issue.number,
                  labels: [correctStatusLabel]
                });
                
                syncedCount++;
                
                // Rate limiting
                await new Promise(resolve => setTimeout(resolve, 100));
              }
            }
            
            console.log(`âœ… Status sync complete: ${syncedCount} synced, ${unchangedCount} unchanged`);

PS C:\Users\dzarf\source\repos\IntelAvbFilter> .\Setup-Driver.bat
========================================
Intel AVB Filter Driver - Quick Setup
========================================

[1] Checking test signing mode...
    Status: ENABLED

[2] Checking for driver build...
    Found: x64\Release\IntelAvbFilter\IntelAvbFilter.sys

[3] Removing old driver installation...
    Stopping service...
    Uninstalling old filter bindings...
    Removing cached drivers...

[4] Installing NDIS filter driver (using netcfg)...
    IMPORTANT: NDIS filters must use netcfg, not pnputil!
Trying to install MS_IntelAvbFilter ...

... x64\Release\IntelAvbFilter\IntelAvbFilter.inf was copied to C:\WINDOWS\INF\oem71.inf.

... done.

    SUCCESS: Filter driver installed and bound to network adapters

[5] Verifying service registration...
[SC] StartService FAILED 1056:

An instance of the service is already running.


[6] Checking service status...

SERVICE_NAME: IntelAvbFilter
        TYPE               : 1  KERNEL_DRIVER
        STATE              : 4  RUNNING
                                (STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0

[7] Testing device interface...
    Running I226 test...
Capabilities (0x000001BF): BASIC_1588 ENHANCED_TS TSN_TAS TSN_FP PCIe_PTM 2_5G MMIO

========================================
SUCCESS! Driver is working with your I226 adapters!
========================================

Run full test suite:
  avb_test_i226.exe selftest

Your I226 adapters support:
  - IEEE 1588 PTP
  - Time-Aware Shaper (TAS)
  - Frame Preemption (FP)
  - PCIe PTM

Setup complete!
Press any key to continue . . .
PS C:\Users\dzarf\source\repos\IntelAvbFilter> .\avb_test_i226.exe selftest
Capabilities (0x000001BF): BASIC_1588 ENHANCED_TS TSN_TAS TSN_FP PCIe_PTM 2_5G MMIO
PTP: not running, attempting start (legacy seq, then SSOT)...
PTP: start failed (SYSTIM still zero)
Device: Intel I226 2.5G Ethernet - Advanced TSN (0x0)

--- Basic I210 register snapshot (legacy offsets) ---
  CTRL(0x00000)   = 0x401C0641
  STATUS(0x00008) = 0x00280683
  SYSTIML        = 0x00000000
  SYSTIMH        = 0x00000000
  TIMINCA        = 0x00000001
  TSYNCRXCTL      = 0x00000010
  TSYNCTXCTL      = 0x00000010
  RXSTMPL         = 0x00000000
  RXSTMPH         = 0x00000000
  TXSTMPL         = 0x00000000
  TXSTMPH         = 0x00000000
  TSAUXC          = 0xF8000000

--- SSOT I210 PTP decode ---
  TSYNCTXCTL raw=0x00000010 EN=1 TYPE=0
  TSYNCRXCTL raw=0x00000010 EN=1 TYPE=0
  RXSTMP = 0x0000000000000000  TXSTMP = 0x0000000000000000
TS=0x0000000000000000
TAS failed (GLE=31)
FP ON OK (0x0)
FP OFF OK (0x0)
PTM ON OK (0x0)
PTM OFF OK (0x0)
MDIO: SKIPPED (unsupported)

Summary: base=OK, optional=FAIL
PS C:\Users\dzarf\source\repos\IntelAvbFilter> .\avb_test_hardware_only.exe
=== Intel AVB Filter Driver I219 Test ===

ERROR: Cannot open IntelAvbFilter device (Error: 3)
Make sure the driver is installed and loaded.
PS C:\Users\dzarf\source\repos\IntelAvbFilter> .\Check-Driver-Status.ps1
=== Intel AVB Driver Debug Analysis ===

[1] Currently Installed Driver:
  Path: C:\Windows\System32\DriverStore\FileRepository\intelavbfilter.inf_amd64_193cae48e479cef7\IntelAvbFilter.sys
  Size: 117952 bytes
  Modified: 12/04/2025 13:59:49
  Build Time: 13:59:49

[2] Local Release Build:
  Size: 117952 bytes
  Modified: 12/04/2025 13:59:49
  Build Time: 13:59:49

[OK] Installed driver matches local build

[3] Service Status:
  Status: Running
  [OK] Driver is loaded

[4] Device Interface Test:
  [OK] Device interface working
  Capabilities (0x000001BF): BASIC_1588 ENHANCED_TS TSN_TAS TSN_FP PCIe_PTM 2_5G MMIO

[5] Debug Output Monitoring:
  [OK] DebugView is running (PID: 3480)

=== Analysis Summary ===

System appears configured correctly.
Check DebugView output for PTP initialization messages

PS C:\Users\dzarf\source\repos\IntelAvbFilter> .\intel_avb_diagnostics.exe
=============================================================================
  Intel AVB Filter Driver - Hardware Only Diagnostics v2.0
  NO SIMULATION - Real hardware problems are immediately visible
=============================================================================

System Information:
  OS Version: 6.2.9200
  Administrator: ? Yes
  Secure Boot: ? Disabled
  Test Signing: ? Disabled (required for development drivers)

Phase 1: Hardware Detection
==========================
Scanning for Intel Ethernet Controllers...

?? Intel Device Found:
   Device ID: 0x125C
   Description: Intel(R) Ethernet Controller I226-V
   Official Name: Intel Ethernet Controller I226-V
   Generation: I226
   AVB Capable: ? Yes
   Advanced TSN: ? Yes
   Capabilities: IEEE 1588, AVB, TSN, TAS, Frame Preemption

?? Intel Device Found:
   Device ID: 0x125C
   Description: Intel(R) Ethernet Controller I226-V
   Official Name: Intel Ethernet Controller I226-V
   Generation: I226
   AVB Capable: ? Yes
   Advanced TSN: ? Yes
   Capabilities: IEEE 1588, AVB, TSN, TAS, Frame Preemption

?? Intel Device Found:
   Device ID: 0x125C
   Description: Intel(R) Ethernet Controller I226-V
   Official Name: Intel Ethernet Controller I226-V
   Generation: I226
   AVB Capable: ? Yes
   Advanced TSN: ? Yes
   Capabilities: IEEE 1588, AVB, TSN, TAS, Frame Preemption

?? Intel Device Found:
   Device ID: 0x125C
   Description: Intel(R) Ethernet Controller I226-V
   Official Name: Intel Ethernet Controller I226-V
   Generation: I226
   AVB Capable: ? Yes
   Advanced TSN: ? Yes
   Capabilities: IEEE 1588, AVB, TSN, TAS, Frame Preemption

?? Intel Device Found:
   Device ID: 0x125C
   Description: Intel(R) Ethernet Controller I226-V
   Official Name: Intel Ethernet Controller I226-V
   Generation: I226
   AVB Capable: ? Yes
   Advanced TSN: ? Yes
   Capabilities: IEEE 1588, AVB, TSN, TAS, Frame Preemption

?? Intel Device Found:
   Device ID: 0x125C
   Description: Intel(R) Ethernet Controller I226-V
   Official Name: Intel Ethernet Controller I226-V
   Generation: I226
   AVB Capable: ? Yes
   Advanced TSN: ? Yes
   Capabilities: IEEE 1588, AVB, TSN, TAS, Frame Preemption

? Found 6 Intel Ethernet Controller(s)

Phase 2: Driver Installation Analysis
====================================
Checking Intel AVB Filter Driver installation...

? IntelAvbFilter service found
   Service State: ? RUNNING

Checking driver files...
   ? x64\Debug\IntelAvbFilter.sys (117952 bytes)
   ? x64\Debug\IntelAvbFilter.inf (3770 bytes)
   ? x64\Debug\IntelAvbFilter.cat - File not found
   ? x64\Debug\IntelAvbFilter.cer (784 bytes)

Phase 3: Device Interface Analysis
=================================
Testing device interface accessibility...

Trying: \\.\IntelAvbFilter
  ? SUCCESS! Device interface accessible

Phase 4: Network Configuration Analysis
======================================
Analyzing network adapter configuration...

Network Connectivity Test:
  ? No internet connectivity
  ??  May indicate network adapter issues

NDIS Filter Binding Analysis:
  Device: Intel(R) Ethernet Controller I226-V
  Filter Bound: ??  Cannot determine without registry access
  Recommendation: Check Network Adapter Properties manually
  Device: Intel(R) Ethernet Controller I226-V
  Filter Bound: ??  Cannot determine without registry access
  Recommendation: Check Network Adapter Properties manually
  Device: Intel(R) Ethernet Controller I226-V
  Filter Bound: ??  Cannot determine without registry access
  Recommendation: Check Network Adapter Properties manually
  Device: Intel(R) Ethernet Controller I226-V
  Filter Bound: ??  Cannot determine without registry access
  Recommendation: Check Network Adapter Properties manually
  Device: Intel(R) Ethernet Controller I226-V
  Filter Bound: ??  Cannot determine without registry access
  Recommendation: Check Network Adapter Properties manually
  Device: Intel(R) Ethernet Controller I226-V
  Filter Bound: ??  Cannot determine without registry access
  Recommendation: Check Network Adapter Properties manually

Phase 5: Hardware Access Analysis
================================
Hardware Access Analysis (Diagnostic Mode)...

??  HARDWARE ACCESS TESTING LIMITATIONS:
   - Cannot test real MMIO access without driver loaded
   - Cannot test PCI configuration access without driver
   - Cannot test register reads/writes without kernel mode
   - Hardware-Only policy prevents simulation testing

?? WHAT WE CAN DETERMINE:
? Hardware Present: 6 Intel controller(s) detected
? Device 1: Intel(R) Ethernet Controller I226-V (ID: 0x125C)
   - AVB Capable: ? Yes
? Device 2: Intel(R) Ethernet Controller I226-V (ID: 0x125C)
   - AVB Capable: ? Yes
? Device 3: Intel(R) Ethernet Controller I226-V (ID: 0x125C)
   - AVB Capable: ? Yes
? Device 4: Intel(R) Ethernet Controller I226-V (ID: 0x125C)
   - AVB Capable: ? Yes
? Device 5: Intel(R) Ethernet Controller I226-V (ID: 0x125C)
   - AVB Capable: ? Yes
? Device 6: Intel(R) Ethernet Controller I226-V (ID: 0x125C)
   - AVB Capable: ? Yes

?? HARDWARE ACCESS VALIDATION PLAN:
1. Install driver using appropriate method for your environment
2. Run hardware-only test application: avb_test_hardware_only.exe
3. Monitor debug output with DebugView.exe
4. Look for these SUCCESS patterns:
   ? 'REAL HARDWARE DISCOVERED: Intel I219'
   ? 'AvbMmioReadHardwareOnly: (REAL HARDWARE)'
   ? 'BAR0=0xf7a00000, Length=0x20000'
5. Look for these FAILURE patterns (good - problems visible!):
   ? 'HARDWARE DISCOVERY FAILED'
   ? 'Hardware not mapped'
   ? 'PCI config read FAILED'

Final Analysis & Recommendations
===============================
=== DIAGNOSTIC SUMMARY ===

? HARDWARE STATUS: 6 Intel controller(s) detected
??  TARGET HARDWARE: I219-LM not found, but other Intel devices available

=== RECOMMENDATIONS ===

?? NEXT STEPS for Intel AVB Filter Driver Testing:

?? INSTALLATION OPTIONS (choose based on your environment):
   A) EV Code Signing Certificate (Corporate/Production):
      - Cost: ~Ç300/year
      - Works with Secure Boot immediately
      - No IT policy violations
      - Recommended for production deployment

   B) Hyper-V Development VM (Corporate/Development):
      - Cost: Free
      - Host system unchanged (IT compliant)
      - Secure Boot can be disabled in VM
      - Full development freedom

   C) Network Control Panel Installation (Limited):
      - Try manual installation via Network Adapter Properties
      - May work if certificate is trusted
      - Limited success with Secure Boot

?? TESTING PROCEDURE (after installation):
   1. Compile: cl avb_test_i219.c /DHARDWARE_ONLY=1 /Fe:test.exe
   2. Install driver using chosen method above
   3. Run: test.exe
   4. Enable DebugView.exe (as Administrator)
   5. Look for 'REAL HARDWARE' vs error messages

? EXPECTED SUCCESS INDICATORS:
   - 'Intel controller resources discovered: BAR0=0x...'
   - 'AvbMmioReadHardwareOnly: (REAL HARDWARE)'
   - 'Control Register: 0x48100248'
   - Network connectivity maintained

? EXPECTED FAILURE INDICATORS (Hardware-Only - No Hidden Problems!):
   - 'HARDWARE DISCOVERY FAILED' ? Fix PCI access
   - 'Hardware not mapped' ? Fix BAR0 discovery
   - 'Cannot open device' ? Fix driver loading
   - Network connection lost ? Fix filter packet processing

?? BOTTOM LINE:
Your Intel AVB Filter Driver implementation is COMPLETE and ready.
Hardware-Only approach ensures all problems are immediately visible.
Choose appropriate installation method for your corporate environment!

=============================================================================
  Hardware Only Diagnostics Complete - All problems are now visible!
=============================================================================
Press any key to continue . . .
PS C:\Users\dzarf\source\repos\IntelAvbFilter> .\debug_device_interface.exe
Intel AVB Filter Driver - Device Interface Debug Tool
====================================================

=== Device Interface Debug Tool ===

Testing various device name patterns...
Trying: \\.\IntelAvbFilter
  ? SUCCESS! Device opened successfully
=== Windows Services Check ===
? IntelAvbFilter service found
   State: RUNNING ?

=== Registry Entries Check ===
Checking: HKLM\SYSTEM\CurrentControlSet\Services\IntelAvbFilter
  ? Registry key exists
     Values: 12
Checking: HKLM\SYSTEM\CurrentControlSet\Control\Class\{4D36E974-E325-11CE-BFC1-08002BE10318}
  ? Registry key exists
     Values: 7
Checking: HKLM\SYSTEM\CurrentControlSet\Control\Network
  ? Registry key exists
     Values: 1

=== NDIS Filter Binding Check ===
Checking for Intel network adapters...
? Network adapter registry found

=== Summary ===
If device interface fails but service/registry exists,
the filter driver may need to be bound to network adapters
using the Network Control Panel method.

Next steps:
1. Use Network Control Panel installation method
2. Check if filter appears in network adapter properties
3. Verify filter is bound to Intel I219 adapter
4. Restart network adapter if needed

Press any key to continue . . .
PS C:\Users\dzarf\source\repos\IntelAvbFilter> .\enhanced_investigation_suite.ps1
Enhanced Intel AVB Hardware Investigation Suite - FINAL
==========================================================
PURPOSE: Complete evidence chain with ChatGPT5 I226 TAS validation runbook
BREAKTHROUGH: Correct register addresses + ChatGPT5 specification order

?? Phase 1: Basic Hardware Investigation
Purpose: Validate register access and basic hardware behavior
? Phase 1 completed successfully

??  Phase 2: Enhanced TAS Investigation (SKIPPED - used wrong registers)
Evidence: ALL tests failed because used 0x08600 instead of 0x3570
Result: Root cause identified - wrong register block entirely
? Phase 2 purpose achieved - proved register address issue

?? Phase 3: Critical Prerequisites Investigation
Purpose: PTP clock verification + missing register discovery
? Phase 3 completed successfully

?? Phase 4: CORRECTED I226 TAS Test (Evidence-based fix)
Purpose: Test TAS activation with CORRECT register addresses
Registers: TQAVCTRL=0x3570, BASET_L/H=0x3314/0x3318, QBVCYCLET=0x331C
? Phase 4 completed successfully

?? Phase 5: ChatGPT5 I226 TAS Validation Runbook (NEW - FINAL VALIDATION)
Purpose: Complete I226 TAS validation following ChatGPT5 specification order
Method: Linux IGC driver sequence + ChatGPT5 validation runbook
Steps: PHC?TSN Control?Cycle Time?Base Time?Queue Windows?Verification?Traffic Proof
? Phase 5 completed successfully

?? Phase 6: Multi-Adapter Comprehensive Validation
Purpose: Validate complete system behavior
? Phase 6 completed successfully

??? Phase 7: TSN IOCTL Handler Verification
Purpose: Confirm corrected implementation works through IOCTL interface
? Phase 7 completed successfully

?? === COMPLETE INVESTIGATION CHAIN WITH CHATGPT5 VALIDATION ===

Evidence Chain Summary:
  ? Phase 1: Register access patterns validated
  ? Phase 2: Wrong register addresses identified (0x08600 vs 0x3570)
  ? Phase 3: PTP clock status and prerequisites analyzed
  ? Phase 4: CORRECTED register addresses tested
  ?? Phase 5: CHATGPT5 SPECIFICATION VALIDATION completed
  ? Phase 6: Multi-adapter functionality confirmed
  ? Phase 7: IOCTL handlers with corrected implementation

?? BREAKTHROUGH ACHIEVEMENTS:
  ?? ROOT CAUSE FIXED: Correct I226 TSN register block implemented!
  ? Previous: TAS_CTRL @ 0x08600 (doesn't exist on I226)
  ? Corrected: TQAVCTRL @ 0x3570 (real I226 TSN control)
  ? Previous: TAS_CONFIG0/1 @ 0x08604/0x08608
  ? Corrected: BASET_L/H @ 0x3314/0x3318
  ? Added: QBVCYCLET @ 0x331C (cycle time register)
  ?? NEW: ChatGPT5 validation runbook implementation

?? Implementation Status:
  ? Driver completely fixed with CORRECT register addresses
  ? Evidence-based I226 TAS implementation complete
  ? Linux IGC driver sequence implemented perfectly
  ? I226-specific FUTSCDDIS handling implemented
  ? ChatGPT5 validation runbook integrated
  ? Complete test suite with all phases

?? CHATGPT5 VALIDATION FEATURES:
  ?? Step 1: Pre-req - I226 PHC (SYSTIM) advancement verification
  ?? Step 2: I226 context selection with VID:DID logging
  ?? Step 3: TSN/Qbv control programming (TQAVCTRL)
  ?? Step 4: Cycle time programming (QBVCYCLET_S/QBVCYCLET)
  ?? Step 5: Base time calculation (future + cycle boundary)
  ?? Step 6: Base time programming with I226 FUTSCDDIS quirk
  ?? Step 7: Queue windows (launch-time mode + full cycle)
  ?? Step 8: Register readback + activation wait
  ?? Step 9: Traffic-side proof validation

?? READY FOR PRODUCTION HARDWARE VALIDATION!
The complete implementation with ChatGPT5 runbook should successfully activate I226 TAS!
PS C:\Users\dzarf\source\repos\IntelAvbFilter>